# See: https://docs.github.com/en/actions/writing-workflows
---
name: Release

on:
  push:

jobs:
  build-windows:
    runs-on: windows-latest
    env:
      # disable Strawberry Perl from being picked up
      # (this is just extra safety—MSYS2 perl is earlier in PATH)
      PERL_IGNORE: C:\Strawberry\perl\bin
    steps:
      - uses: actions/checkout@v4

      # 1) Install MSYS2 + toolchain (perl, make, pkg-config)
      - name: Setup MSYS2 toolchain
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-perl
            mingw-w64-x86_64-pkg-config
            make

      # 2) Prepend MSYS2 mingw64/bin to the PATH for everything that follows
      - name: Prepend MSYS2 to PATH
        run: echo "C:\msys64\mingw64\bin" >> $Env:GITHUB_PATH

      # 3) Build in PowerShell so that rustup/cargo are on PATH,
      #    and openssl-sys’s vendored build will pick up MSYS2 perl.
      - name: Build (vendored OpenSSL)
        uses: asimov-platform/build-rust-action@v3
        with:
          target: x86_64-pc-windows-gnu
          artifact-name: asimov-dataset-cli
          artifact-prefix: release
          binary-name: asimov-dataset-cli
          binary-extension: exe
          rust-toolchain: 1.85.0
